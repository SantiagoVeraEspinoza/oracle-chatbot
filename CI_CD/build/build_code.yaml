version: 0.1
component: build
timeoutInSeconds: 6000
runAs: root
shell: bash

env:
  variables:
    - DOCKER_REGISTRY
  vaultVariables:
    - SECRET_OCID
  

steps:
  - type: Command
    name: "RetrieveSecret"
    timeoutInSeconds: 40
    command: |
      echo "Retrieving secret from OCI Vault..."
      SECRET_OCID="ocid1.vaultsecret.oc1.mx-queretaro-1.amaaaaaaal4j5giaqxn6ni4zsmthysgv7zw3ey5wwves6hqfz2iynckf7ela"
      export DOCKER_REGISTRY=$(oci secrets secret-bundle get --secret-id "${SECRET_OCID}" --query 'data."secret-bundle-content"."content"' --raw-output | base64 --decode)
      echo "Secret retrieved and stored in environment variable DOCKER_REGISTRY"
      echo $DOCKER_REGISTRY

  - type: Command
    name: "BuildAndPackage"
    timeoutInSeconds: 600
    command: |
      cd MtdrSpring/backend/
      mvn clean package spring-boot:repackage
      echo "Created build successfully"

  - type: Command
    name: "GenerateImage"
    timeoutInSeconds: 600
    command: |
      echo "Test"

outputArtifacts:
  - name: MyTodoListApp
    type: JAR
    location: target/*.jar
