version: 0.1
component: build
timeoutInSeconds: 10000
shell: bash
failImmediatelyOnError: true

env:
  variables:
    IMAGE_NAME: "todolistapp-springboot"
    IMAGE_VERSION: "0.1"
  vaultVariables:
    DOCKER_REGISTRY: "ocid1.vaultsecret.oc1.mx-queretaro-1.amaaaaaaal4j5giaqxn6ni4zsmthysgv7zw3ey5wwves6hqfz2iynckf7ela"
  exportedVariables:
    - IMAGE

steps:
  - type: Command
    name: "BuildAndPackage"
    timeoutInSeconds: 600
    command: |
      cd MtdrSpring/backend/
      mvn clean package spring-boot:repackage
      echo "Created build successfully"

  - type: Command
    name: "GenerateImage"
    timeoutInSeconds: 600
    command: |
      IMAGE=${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_VERSION}
      docker build -f Dockerfile -t "$IMAGE" .

outputArtifacts:
  - name: MyTodoListAppImage
    type: DOCKER_IMAGE
    location: "$IMAGE"
